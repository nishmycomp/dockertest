<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Queue Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --primary: #794d9a; --secondary: #bc1b8d; --dashboard: #412e80; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-semibold">
          <span class="bg-clip-text text-transparent bg-gradient-to-r from-[#412e80] to-[#bc1b8d]">PDF Service Queue Monitor</span>
        </h1>
        <p class="text-sm text-gray-600">Multi-tenant queue dashboard with real-time stats</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="status-pill" class="inline-flex items-center px-2 py-1 text-xs rounded bg-[#f5ecff] text-[#412e80]">Idle</span>
        <button id="refresh-btn" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded hover:bg-gray-100">Refresh</button>
      </div>
    </div>

    <!-- Top toolbar -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white border border-gray-200 rounded p-4">
        <label class="block text-sm text-gray-700 mb-1">Tenant</label>
        <select id="tenant-select" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#794d9a] focus:border-transparent">
          <option value="app_imploy_com_au">app.imploy.com.au</option>
          <option value="tenant_2">tenant_2</option>
        </select>
      </div>
      <div class="bg-white border border-gray-200 rounded p-4">
        <label class="block text-sm text-gray-700 mb-2">Actions</label>
        <div class="flex gap-2">
          <button id="pause-btn" class="px-3 py-2 text-sm bg-amber-50 text-amber-700 border border-amber-200 rounded hover:bg-amber-100">Pause</button>
          <button id="resume-btn" class="px-3 py-2 text-sm rounded text-white bg-[#794d9a] hover:bg-[#6e448d]">Resume</button>
          <button id="clear-btn" class="px-3 py-2 text-sm bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100">Clear</button>
        </div>
      </div>
      <div class="bg-white border border-gray-200 rounded p-4">
        <label class="block text-sm text-gray-700 mb-2">Auto-refresh</label>
        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm"><input id="auto-refresh" type="checkbox" class="rounded border-gray-300"> Enable</label>
          <select id="refresh-interval" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#794d9a] focus:border-transparent">
            <option value="3000">3s</option>
            <option value="5000" selected>5s</option>
            <option value="10000">10s</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Batch section -->
    <div class="bg-white border border-gray-200 rounded p-4 mb-6">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div class="w-full md:w-1/2">
          <label class="block text-sm text-gray-700 mb-1">Batch ID</label>
          <input id="batch-id" type="text" placeholder="e.g., 2025-10-10-INV-BATCH-001" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#794d9a] focus:border-transparent" />
        </div>
        <div class="w-full md:w-1/2 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-700 mb-1">Total</label>
            <input id="batch-total" type="number" min="1" placeholder="10" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#794d9a] focus:border-transparent" />
          </div>
          <div class="flex items-end">
            <button id="batch-start" class="w-full px-3 py-2 text-sm rounded text-white bg-[#794d9a] hover:bg-[#6e448d]">Start Batch</button>
          </div>
        </div>
      </div>
      <div id="batch-progress-wrap" class="mt-4 hidden">
        <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
          <span id="batch-progress-label">Batch progress</span>
          <span id="batch-progress-count">0 / 0</span>
        </div>
        <div class="w-full bg-gray-100 rounded h-2 overflow-hidden">
          <div id="batch-progress-bar" class="h-2 bg-gradient-to-r from-[#412e80] to-[#bc1b8d]" style="width: 0%"></div>
        </div>
        <div class="mt-2 text-xs text-gray-600">
          <span>Current batch:</span>
          <span id="batch-current-id" class="font-medium text-[#412e80]">â€”</span>
        </div>
      </div>
    </div>

    <!-- Summary cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white border border-gray-200 rounded p-4 border-t-4 border-t-[#412e80]"><div class="text-xs text-gray-600">Waiting</div><div id="sum-waiting" class="text-2xl font-semibold">0</div></div>
      <div class="bg-white border border-gray-200 rounded p-4 border-t-4 border-t-[#794d9a]"><div class="text-xs text-gray-600">Active</div><div id="sum-active" class="text-2xl font-semibold">0</div></div>
      <div class="bg-white border border-gray-200 rounded p-4 border-t-4 border-t-[#bc1b8d]"><div class="text-xs text-gray-600">Completed</div><div id="sum-completed" class="text-2xl font-semibold">0</div></div>
      <div class="bg-white border border-gray-200 rounded p-4 border-t-4 border-t-red-400"><div class="text-xs text-gray-600">Failed</div><div id="sum-failed" class="text-2xl font-semibold">0</div></div>
    </div>

    <!-- Tenant cards -->
    <div id="tenant-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

    <!-- Job lists -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="bg-white border border-gray-200 rounded">
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
          <h2 class="text-sm font-medium">Recent Completed</h2>
          <button id="reload-completed" class="text-xs text-[#794d9a] hover:text-[#6e448d]">Reload</button>
        </div>
        <div id="completed-list" class="p-4 text-sm text-gray-700 space-y-2">
          <div class="text-gray-500">No data</div>
        </div>
      </div>
      <div class="bg-white border border-gray-200 rounded">
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
          <h2 class="text-sm font-medium">Recent Failed</h2>
          <button id="reload-failed" class="text-xs text-[#794d9a] hover:text-[#6e448d]">Reload</button>
        </div>
        <div id="failed-list" class="p-4 text-sm text-gray-700 space-y-2">
          <div class="text-gray-500">No data</div>
        </div>
      </div>
      <div class="bg-white border border-gray-200 rounded">
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
          <h2 class="text-sm font-medium">Queue Logs</h2>
          <button id="logs-clear" class="text-xs text-[#794d9a] hover:text-[#6e448d]">Clear</button>
        </div>
        <div id="logs-list" class="p-4 text-xs text-gray-700 space-y-1 max-h-64 overflow-auto">
          <div class="text-gray-500">No logs</div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div id="toast" class="fixed bottom-4 right-4 hidden"></div>
  </div>

  <script>
    // Determine API base depending on how the dashboard is served
    const isProxied = window.location.pathname.startsWith('/queue');
    const API_BASE = isProxied ? '/queue/api' : '/api';
    const statusPill = document.getElementById('status-pill');
    const tenantSelect = document.getElementById('tenant-select');
    const sumWaiting = document.getElementById('sum-waiting');
    const sumActive = document.getElementById('sum-active');
    const sumCompleted = document.getElementById('sum-completed');
    const sumFailed = document.getElementById('sum-failed');
    const tenantCards = document.getElementById('tenant-cards');

    const autoRefresh = document.getElementById('auto-refresh');
    const refreshInterval = document.getElementById('refresh-interval');
    const refreshBtn = document.getElementById('refresh-btn');

    const pauseBtn = document.getElementById('pause-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const clearBtn = document.getElementById('clear-btn');

    const completedList = document.getElementById('completed-list');
    const failedList = document.getElementById('failed-list');

    let timer = null;

    function showToast(message, type = 'info') {
      const el = document.getElementById('toast');
      const styles = {
        info: 'bg-gray-900 text-white',
        success: 'bg-[#794d9a] text-white',
        error: 'bg-red-600 text-white',
      };
      el.className = `fixed bottom-4 right-4 px-3 py-2 rounded text-sm shadow ${styles[type]}`;
      el.textContent = message;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 2500);
    }

    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`${res.status}: ${url}`);
      return await res.json();
    }

    function renderSummary(allStats) {
      const totals = { waiting: 0, active: 0, completed: 0, failed: 0 };
      Object.values(allStats || {}).forEach(s => {
        if (!s) return;
        totals.waiting += s.waiting;
        totals.active += s.active;
        totals.completed += s.completed;
        totals.failed += s.failed;
      });
      sumWaiting.textContent = totals.waiting;
      sumActive.textContent = totals.active;
      sumCompleted.textContent = totals.completed;
      sumFailed.textContent = totals.failed;
      const active = totals.active > 0;
      statusPill.textContent = active ? 'Active' : 'Idle';
      statusPill.className = `inline-flex items-center px-2 py-1 text-xs rounded ${active ? 'bg-[#eaf7f0] text-green-700' : 'bg-[#f5ecff] text-[#412e80]'}`;
    }

    function renderTenantCards(allStats) {
      tenantCards.innerHTML = '';
      Object.entries(allStats || {}).forEach(([tenantId, s]) => {
        if (!s) return;
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded overflow-hidden';
        card.innerHTML = `
          <div class="h-1.5 bg-gradient-to-r from-[#412e80] to-[#bc1b8d]"></div>
          <div class="p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-medium">${tenantId}</div>
              <span class="text-xs ${s.active > 0 ? 'text-green-700' : 'text-gray-600'}">${s.active > 0 ? 'Active' : 'Idle'}</span>
            </div>
            <div class="grid grid-cols-4 gap-3 text-center">
              <div><div class="text-lg font-semibold">${s.waiting}</div><div class="text-[11px] text-gray-600">Waiting</div></div>
              <div><div class="text-lg font-semibold text-[#794d9a]">${s.active}</div><div class="text-[11px] text-gray-600">Active</div></div>
              <div><div class="text-lg font-semibold text-[#bc1b8d]">${s.completed}</div><div class="text-[11px] text-gray-600">Done</div></div>
              <div><div class="text-lg font-semibold text-red-500">${s.failed}</div><div class="text-[11px] text-gray-600">Failed</div></div>
            </div>
          </div>
        `;
        tenantCards.appendChild(card);
      });
    }

    async function loadStats() {
      try {
        const data = await fetchJSON(`${API_BASE}/stats`);
        if (!data.success) throw new Error('Stats failed');
        renderSummary(data.data);
        renderTenantCards(data.data);
      } catch (e) {
        showToast('Failed to load stats', 'error');
      }
    }

    // ---- Batch client logic ----
    const batchIdInput = document.getElementById('batch-id');
    const batchTotalInput = document.getElementById('batch-total');
    const batchStartBtn = document.getElementById('batch-start');
    const batchProgressWrap = document.getElementById('batch-progress-wrap');
    const batchProgressBar = document.getElementById('batch-progress-bar');
    const batchProgressCount = document.getElementById('batch-progress-count');
    const batchProgressLabel = document.getElementById('batch-progress-label');
    let batchPollTimer = null;
    const logsList = document.getElementById('logs-list');
    const logsClearBtn = document.getElementById('logs-clear');
    const batchCurrentId = document.getElementById('batch-current-id');

    function addLog(message, level = 'info') {
      const ts = new Date().toLocaleTimeString();
      const row = document.createElement('div');
      const color = level === 'error' ? 'text-red-600' : (level === 'success' ? 'text-green-700' : 'text-gray-700');
      row.className = `${color}`;
      row.textContent = `[${ts}] ${message}`;
      if (logsList.firstElementChild && logsList.firstElementChild.classList.contains('text-gray-500')) {
        logsList.innerHTML = '';
      }
      logsList.appendChild(row);
      logsList.scrollTop = logsList.scrollHeight;
    }

    async function startBatch() {
      const tenantId = tenantSelect.value;
      const batchId = (batchIdInput.value || '').trim();
      const total = parseInt(batchTotalInput.value, 10);
      if (!batchId || !Number.isFinite(total) || total <= 0) {
        showToast('Provide batchId and total > 0', 'error');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/batch/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tenantId, batchId, total })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Start failed');
        showToast('Batch started', 'success');
        addLog(`Batch started: ${batchId} (total ${total})`, 'success');
        batchCurrentId.textContent = batchId;
        batchProgressWrap.classList.remove('hidden');
        pollBatch(tenantId, batchId, total);
      } catch (e) {
        showToast('Failed to start batch', 'error');
        addLog(`Failed to start batch: ${e.message || e}`, 'error');
      }
    }

    async function pollBatch(tenantId, batchId, declaredTotal) {
      if (batchPollTimer) clearInterval(batchPollTimer);
      const updateOnce = async () => {
        try {
          const res = await fetch(`${API_BASE}/batch/${tenantId}/${batchId}`);
          const data = await res.json();
          if (!data.success) throw new Error();
          const total = data.data.total || declaredTotal || 0;
          const completed = data.data.completed || 0;
          const failed = data.data.failed || 0;
          const done = completed + failed;
          const pct = total > 0 ? Math.min(100, Math.round((done / total) * 100)) : 0;
          batchProgressBar.style.width = pct + '%';
          batchProgressCount.textContent = `${done} / ${total}`;
          batchProgressLabel.textContent = failed > 0 ? `Batch progress (failed: ${failed})` : 'Batch progress';
          addLog(`Batch ${batchId}: ${done}/${total} (failed ${failed})`);
          if (done >= total && total > 0) {
            clearInterval(batchPollTimer);
            addLog(`Batch ${batchId} completed`, 'success');
          }
        } catch (_) {
          // ignore transient errors
        }
      };
      await updateOnce();
      batchPollTimer = setInterval(updateOnce, 2000);
    }

    async function tenantAction(action) {
      const tenantId = tenantSelect.value;
      try {
        const res = await fetch(`/api/tenant/${tenantId}/${action}`, { method: 'POST' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Action failed');
        showToast(`${action.charAt(0).toUpperCase() + action.slice(1)} successful`, 'success');
        addLog(`Tenant ${tenantId}: ${action} successful`, 'success');
        loadStats();
      } catch (e) {
        showToast(`Failed to ${action}`, 'error');
        addLog(`Tenant ${tenantId}: ${action} failed`, 'error');
      }
    }

    async function loadRecentLists() {
      completedList.innerHTML = '<div class="text-gray-500">Awaiting completed jobs...</div>';
      failedList.innerHTML = '<div class="text-gray-500">Awaiting failed jobs...</div>';
    }

    function startAutoRefresh() {
      if (timer) clearInterval(timer);
      if (autoRefresh.checked) {
        timer = setInterval(() => {
          loadStats();
          loadRecentLists();
        }, parseInt(refreshInterval.value, 10));
      }
    }

    // Event bindings
    refreshBtn.addEventListener('click', () => { loadStats(); loadRecentLists(); });
    autoRefresh.addEventListener('change', startAutoRefresh);
    refreshInterval.addEventListener('change', startAutoRefresh);
    pauseBtn.addEventListener('click', () => tenantAction('pause'));
    resumeBtn.addEventListener('click', () => tenantAction('resume'));
    clearBtn.addEventListener('click', () => tenantAction('clear'));
    logsClearBtn.addEventListener('click', () => { logsList.innerHTML = '<div class="text-gray-500">No logs</div>'; });

    // Initial
    loadStats();
    loadRecentLists();
    autoRefresh.checked = true;
    startAutoRefresh();
  </script>
</body>
</html>
